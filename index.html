<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦åƒå•¥ - åˆé¤éš¨æ©Ÿé¸æ“‡å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* æ·ºç°è‰²èƒŒæ™¯ */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- ç‰ˆæœ¬è™Ÿç¢¼é¡¯ç¤ºå€åŸŸ (æ›´æ–°ç‚º v8.0) -->
        <div class="text-right p-2 text-xs text-gray-500 bg-gray-50 border-b border-gray-100">
            ç‰ˆæœ¬è™Ÿ: v8.0
        </div>
        
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="p-6 bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-md">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center tracking-tight">
                ğŸœ è¦åƒå•¥ ğŸ”
            </h1>
            <p class="text-center text-sm mt-1 opacity-90">è®“å‘½é‹å¹«ä½ æ±ºå®šä»Šå¤©çš„åˆé¤ï¼</p>
        </header>

        <!-- ç¬¬ä¸€å€‹å€åŸŸï¼šéš¨æ©Ÿé¸æ“‡å™¨ -->
        <section id="selection-area" class="p-6 border-b border-gray-100">
            <div class="flex flex-col items-center space-y-4">
                
                <!-- éš¨æ©Ÿé¸æ“‡æŒ‰éˆ• -->
                <button id="random-button" 
                        class="w-full sm:w-auto px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl transition duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-95">
                    ä»Šå¤©åˆé¤åƒå“ªé–“ï¼Ÿ
                </button>

                <!-- çµæœé¡¯ç¤ºå€ -->
                <div id="result-display" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-center min-h-[8rem] flex flex-col justify-center items-center">
                    <p class="text-gray-500 italic">ğŸ‘† é»æ“ŠæŒ‰éˆ•ï¼Œé–‹å§‹éš¨æ©Ÿé¸æ“‡ï¼</p>
                    <p id="loading-message" class="hidden text-blue-500 font-semibold mt-2">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </section>

        <!-- ç¬¬äºŒå€‹å€åŸŸï¼šåº—å®¶è³‡æ–™åˆ—è¡¨ (ç¯©é¸å™¨) -->
        <section id="data-area" class="p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">ğŸ½ï¸ åº—å®¶æ¸…å–® (Supabase è³‡æ–™)</h2>
            
            <!-- åƒ¹ä½ç¯©é¸å™¨ -->
            <div class="mb-6 flex flex-wrap items-center space-x-4">
                <label for="price-filter" class="text-gray-700 font-medium whitespace-nowrap">ä¾åƒ¹ä½ç¯©é¸:</label>
                <select id="price-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
                    <option value="all">æ‰€æœ‰åƒ¹ä½</option>
                    <!-- !!! é—œéµæ›´æ–°: ä½¿ç”¨ä¸­æ–‡å­—å…ƒä½œç‚º valueã€‚è«‹ç¢ºä¿ Supabase price_range æ¬„ä½çš„å€¼å®Œå…¨åŒ¹é…é€™äº›å­—ä¸² !!! -->
                    <option value="å¹³åƒ¹">å¹³åƒ¹</option> 
                    <option value="ä¸­">ä¸­</option>
                    <option value="ä¸­-ä¸­é«˜">ä¸­-ä¸­é«˜</option>
                    <option value="é«˜">é«˜</option>
                </select>
            </div>
            
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table id="restaurant-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åº—å®¶åç¨±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡å‹</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åƒ¹ä½</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‡Ÿæ¥­æ™‚é–“</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åœ°åœ–</th>
                        </tr>
                    </thead>
                    <tbody id="restaurant-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- è³‡æ–™å°‡æœƒé€é JavaScript è¼‰å…¥é€™è£¡ -->
                        <tr>
                            <td colspan="5" class="px-4 py-4 text-center text-gray-400 italic">è³‡æ–™è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- è¼‰å…¥ Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // --- 1. Supabase è¨­å®š ---
        // Supabase URL å’Œ Anon Key
        const SUPABASE_URL = 'https://qhhobqefysunhlfonlob.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoaG9icWVmeXN1bmhsZm9ubG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzMwNTIsImV4cCI6MjA4MDc0OTA1Mn0.n5jZzxuPDsfUVWp1-GgYKqT_kMZ0q5CoTsfWkCyls-A';
        
        let supabaseClient = null;

        // --- 2. DOM å…ƒç´ åƒè€ƒ ---
        const randomButton = document.getElementById('random-button');
        const resultDisplay = document.getElementById('result-display');
        const restaurantTableBody = document.getElementById('restaurant-table-body');
        const loadingMessage = document.getElementById('loading-message');
        const priceFilter = document.getElementById('price-filter'); // ç¯©é¸å™¨åƒè€ƒ

        let allRestaurants = []; // å„²å­˜æ‰€æœ‰å¾ Supabase å–å¾—çš„åº—å®¶è³‡æ–™

        // --- 3. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        /**
         * @description æ¸²æŸ“åº—å®¶è³‡æ–™åˆ°è¡¨æ ¼ä¸­ (ç¬¬äºŒå€‹å€åŸŸ)
         * @param {Array<Object>} restaurants - åº—å®¶ç‰©ä»¶é™£åˆ—
         */
        function renderRestaurantTable(restaurants) {
            restaurantTableBody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

            if (restaurants.length === 0) {
                const selectedPriceText = priceFilter.value !== 'all' ? ` (åœ¨ ${priceFilter.options[priceFilter.selectedIndex].text} ç¯©é¸æ¢ä»¶ä¸‹)` : '';
                restaurantTableBody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">ç›®å‰æ¸…å–®æ²’æœ‰ä»»ä½•åº—å®¶è³‡æ–™${selectedPriceText}ã€‚</td></tr>`;
                return;
            }

            restaurants.forEach(restaurant => {
                const row = restaurantTableBody.insertRow();
                // ä½¿ç”¨ Tailwind æ¨£å¼è¨­å®šè¡¨æ ¼è¡Œ
                row.className = 'hover:bg-yellow-50 transition duration-150';

                // ç¢ºä¿ link æ¬„ä½æ˜¯æœ‰æ•ˆçš„ URLï¼Œé¿å…éŒ¯èª¤
                const mapLink = restaurant.google_map_link && restaurant.google_map_link.startsWith('http') 
                                ? restaurant.google_map_link 
                                : '#';

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${restaurant.name || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${restaurant.type || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${restaurant.price_range || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${restaurant.opening_hours || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        ${mapLink !== '#' ? 
                            `<a href="${mapLink}" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold">åœ°åœ–é€£çµ</a>` 
                            : '<span class="text-gray-400">ç„¡é€£çµ</span>'
                        }
                    </td>
                `;
            });
        }

        /**
         * @description å¾ Supabase è¼‰å…¥æ‰€æœ‰åº—å®¶è³‡æ–™ (æ ¹æ“šç¯©é¸æ¢ä»¶)
         */
        async function loadRestaurants() {
            loadingMessage.classList.remove('hidden'); // é¡¯ç¤ºè¼‰å…¥è¨Šæ¯
            
            // æª¢æŸ¥æ†‘è­‰
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                const errorMsg = '<tr><td colspan="5" class="px-4 py-4 text-center text-red-600 font-bold">âŒ éŒ¯èª¤ï¼šè«‹åœ¨ç¨‹å¼ç¢¼ä¸­æ›¿æ› SUPABASE_URL å’Œ SUPABASE_ANON_KEY æ†‘è­‰ï¼</td></tr>';
                restaurantTableBody.innerHTML = errorMsg;
                resultDisplay.innerHTML = '<p class="text-red-600 font-bold">âš ï¸ è¨­å®šéŒ¯èª¤ï¼šè«‹æª¢æŸ¥ä¸¦å¡«å¯« Supabase æ†‘è­‰ï¼</p>';
                loadingMessage.classList.add('hidden');
                return; // çµ‚æ­¢åŸ·è¡Œ
            }

            // åœ¨ç¢ºèªæ†‘è­‰æœ‰æ•ˆå¾Œæ‰åˆå§‹åŒ–å®¢æˆ¶ç«¯
            if (!supabaseClient) {
                try {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸã€‚");
                } catch (e) {
                    console.error('Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–å¤±æ•—:', e);
                    resultDisplay.innerHTML = '<p class="text-red-600 font-bold">âš ï¸ é€£ç·šéŒ¯èª¤ï¼šSupabase URL ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¢º (éœ€åŒ…å« https://)ã€‚</p>';
                    loadingMessage.classList.add('hidden');
                    return;
                }
            }
            
            try {
                // åŸºç¤æŸ¥è©¢
                let query = supabaseClient
                    .from('restaurants')
                    .select('name, type, price_range, opening_hours, google_map_link');
                
                // å–å¾—é¸å®šçš„åƒ¹ä½ç¯©é¸å€¼
                const selectedPrice = priceFilter.value;

                // æ‡‰ç”¨åƒ¹ä½ç¯©é¸
                if (selectedPrice !== 'all') {
                    // Supabase çš„ç¯©é¸æ¢ä»¶ï¼šprice_range æ¬„ä½å¿…é ˆç­‰æ–¼é¸å®šçš„å€¼
                    // é€™å€‹å€¼å¿…é ˆèˆ‡ <select> option çš„ value å±¬æ€§å®Œå…¨ä¸€è‡´ã€‚
                    query = query.eq('price_range', selectedPrice); 
                }

                // åŸ·è¡ŒæŸ¥è©¢
                const { data, error } = await query;

                if (error) {
                    console.error('Supabase è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                    resultDisplay.innerHTML = '<p class="text-red-600 font-bold">âš ï¸ è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼è«‹æª¢æŸ¥ Supabase è¨­å®šèˆ‡é€£ç·šï¼Œä»¥åŠè³‡æ–™åº«çš„ RLS è¦å‰‡ã€‚</p>';
                    restaurantTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-red-600 italic">ç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚</td></tr>';
                    return;
                }

                allRestaurants = data; // æ›´æ–°å…¨åŸŸè®Šæ•¸ (ç¾åœ¨åªåŒ…å«ç¯©é¸å¾Œçš„è³‡æ–™)
                renderRestaurantTable(data); // æ¸²æŸ“è¡¨æ ¼
                
                // æ›´æ–°éš¨æ©Ÿé¸æ“‡å€åŸŸçš„æç¤º
                if (data.length === 0) {
                     resultDisplay.innerHTML = '<p class="text-orange-500 font-bold">ç¯©é¸çµæœï¼šæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—å®¶ï¼</p>';
                } else {
                     resultDisplay.innerHTML = `<p class="text-gray-500 italic">ğŸ‘† å·²ç¯©é¸å‡º ${data.length} é–“åº—å®¶ï¼Œé»æ“ŠæŒ‰éˆ•éš¨æ©Ÿé¸æ“‡ï¼</p>`;
                }

            } catch (err) {
                console.error('é€£ç·šæˆ–è§£æéŒ¯èª¤:', err);
                resultDisplay.innerHTML = '<p class="text-red-600 font-bold">âš ï¸ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼</p>';
            } finally {
                loadingMessage.classList.add('hidden'); // éš±è—è¼‰å…¥è¨Šæ¯
            }
        }

        /**
         * @description éš¨æ©Ÿé¸æ“‡ä¸€å€‹åº—å®¶ä¸¦é¡¯ç¤ºçµæœ (ç¬¬ä¸€å€‹å€åŸŸ)
         */
        function selectRandomRestaurant() {
            // å¦‚æœ supabaseClient å°šæœªåˆå§‹åŒ–ï¼Œå‰‡ç›´æ¥é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            if (!supabaseClient) {
                resultDisplay.innerHTML = '<p class="text-red-600 font-bold">âš ï¸ è«‹å…ˆè§£æ±º Supabase é€£ç·šæ†‘è­‰å•é¡Œï¼</p>';
                return;
            }
            
            randomButton.disabled = true; // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
            
            // ç¾åœ¨ allRestaurants å·²ç¶“æ˜¯ç¯©é¸å¾Œçš„æ¸…å–®
            if (allRestaurants.length === 0) {
                resultDisplay.innerHTML = '<p class="text-red-600 font-bold">åº—å®¶æ¸…å–®æ˜¯ç©ºçš„ï¼è«‹å…ˆæ–°å¢è³‡æ–™æˆ–æ”¾å¯¬ç¯©é¸æ¢ä»¶å†è©¦ã€‚</p>';
                randomButton.disabled = false;
                return;
            }

            // éš¨æ©Ÿç”¢ç”Ÿä¸€å€‹ç´¢å¼•
            const randomIndex = Math.floor(Math.random() * allRestaurants.length);
            
            // å–å¾—éš¨æ©Ÿé¸æ“‡çš„åº—å®¶
            const selectedRestaurant = allRestaurants[randomIndex];

            // è¨­ç½®ä¸€å€‹ç°¡å–®çš„å‹•ç•«æ•ˆæœ (ä¾‹å¦‚ï¼šæ—‹è½‰æ–‡å­—)
            resultDisplay.innerHTML = '<p class="text-3xl font-extrabold text-gray-700 animate-pulse">æ­£åœ¨ç‚ºæ‚¨é¸æ“‡ä¸­...</p>';
            
            // å»¶é²é¡¯ç¤ºçµæœï¼Œæ¨¡æ“¬æ€è€ƒéç¨‹
            setTimeout(() => {
                randomButton.disabled = false; // å•Ÿç”¨æŒ‰éˆ•
                
                // ç¢ºä¿ link æ¬„ä½æ˜¯æœ‰æ•ˆçš„ URL
                const mapLink = selectedRestaurant.google_map_link && selectedRestaurant.google_map_link.startsWith('http') 
                                ? selectedRestaurant.google_map_link 
                                : '#';

                resultDisplay.innerHTML = `
                    <h3 class="text-3xl font-extrabold text-green-700 mt-2">ğŸ‰ ä»Šæ—¥åˆé¤å°±æ˜¯ï¼š<span class="text-red-600">${selectedRestaurant.name}</span></h3>
                    <div class="mt-3 text-lg space-y-1">
                        <p>ğŸœ é¡å‹: <span class="font-semibold">${selectedRestaurant.type || 'æœªçŸ¥'}</span></p>
                        <p>ğŸ’° åƒ¹ä½: <span class="font-semibold">${selectedRestaurant.price_range || 'æœªçŸ¥'}</span></p>
                        <p>ğŸ•’ ç‡Ÿæ¥­æ™‚é–“: <span class="font-semibold">${selectedRestaurant.opening_hours || 'æœªçŸ¥'}</span></p>
                    </div>
                    ${mapLink !== '#' ? 
                        `<a href="${mapLink}" target="_blank" class="mt-4 inline-block px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition duration-150">
                            ğŸ—ºï¸ æŸ¥çœ‹ Google åœ°åœ–
                        </a>` 
                        : '<p class="text-gray-400 mt-4">ç„¡åœ°åœ–é€£çµ</p>'
                    }
                `;
            }, 1500); // å»¶é² 1.5 ç§’
        }

        // --- 4. äº‹ä»¶ç›£è½èˆ‡åˆå§‹åŒ– ---

        // ç›£è½æŒ‰éˆ•é»æ“Šäº‹ä»¶
        randomButton.addEventListener('click', selectRandomRestaurant);
        
        // ç›£è½åƒ¹ä½ç¯©é¸å™¨è®Šå‹•ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™
        priceFilter.addEventListener('change', loadRestaurants);

        // ç¶²é è¼‰å…¥å®Œæˆæ™‚ï¼Œç«‹å³è¼‰å…¥åº—å®¶è³‡æ–™
        document.addEventListener('DOMContentLoaded', loadRestaurants);

    </script>
</body>
</html>
