<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦åƒå•¥ï¼Ÿ - Leaflet/OSM ç‰ˆæœ¬</title>
    
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* Leaflet åœ°åœ–å®¹å™¨æ¨£å¼ */
        #map-container {
            height: 300px; /* å›ºå®šåœ°åœ–é«˜åº¦ */
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            z-index: 0; /* ç¢ºä¿åœ°åœ–ä¸æœƒè“‹éå…¶ä»–å…ƒç´  */
        }
        /* å®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“åˆ—è¡¨çœ‹èµ·ä¾†æ›´ç¾è§€ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 3px;
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        /* éš±è— Leaflet å…§å»ºçš„é è¨­æ¨™è¨˜ï¼Œå› ç‚ºæˆ‘å€‘ä½¿ç”¨è‡ªå®šç¾©æ¨™è¨˜ */
        .leaflet-marker-icon.custom-div-icon {
            border: none;
            background: none;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <!-- ç¶²ç«™æ¨™é¡Œèˆ‡ç‰ˆæœ¬è™Ÿ -->
    <header class="text-center p-4 pt-8">
        <!-- é¡¯ç¤ºç‰ˆæœ¬è™Ÿç¢¼ -->
        <div class="absolute top-2 right-2 text-xs text-gray-400 p-1 border border-gray-200 rounded-lg">
            ç‰ˆæœ¬è™Ÿç¢¼: <span id="app-version">11 (Fix 400)</span>
        </div>
        
        <h1 class="text-5xl font-extrabold text-indigo-700 tracking-tighter">
            è¦åƒå•¥ <span class="text-yellow-500">?</span>
        </h1>
        <p class="text-gray-500 mt-2">è¼¸å…¥åœ°å€ï¼Œé›»è…¦éš¨æ©Ÿå¹«æ‚¨é¸æ“‡ï¼Œè§£æ±ºé¸æ“‡å›°é›£ç—‡ï¼</p>
        <p class="text-xs text-red-500 mt-1 font-medium">âš ï¸ æ³¨æ„ï¼šæœ¬æ‡‰ç”¨ä½¿ç”¨ Leaflet/OpenStreetMap æœå‹™ï¼Œé€Ÿåº¦å’Œæº–ç¢ºæ€§å¯èƒ½å—é™ã€‚</p>
    </header>

    <!-- ç¸½é«”ä½ˆå±€ -->
    <main class="max-w-3xl mx-auto p-4 sm:p-8">
        
        <!-- ======================================================= -->
        <!-- å€åŸŸä¸€: åœ°å€è¼¸å…¥èˆ‡åœ°åœ–é¡¯ç¤º -->
        <!-- ======================================================= -->
        <section id="local-section" class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-500 h-full">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                <!-- MapPin Icon (Lucide SVG) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-indigo-500"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                åœ°é»è¨­å®šèˆ‡åº—å®¶é¸æ“‡ (<span id="local-store-count">0</span> é–“)
            </h2>
            
            <!-- ğŸ“ åœ°å€è¼¸å…¥å€åŸŸ -->
            <div id="address-input-controls" class="p-3 bg-indigo-50 rounded-xl mt-3 mb-4 border border-indigo-200">
                <p class="text-xs font-semibold text-indigo-700 mb-2 flex items-center">
                    <!-- Home Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    è¼¸å…¥æ‚¨æƒ³è¦æœå°‹çš„åŸºæº–åœ°å€ (ç¯„ä¾‹ï¼šå°åŒ—è»Šç«™)
                </p>
                <div class="flex flex-wrap gap-2 items-stretch">
                    <input 
                        type="text" 
                        id="search-address" 
                        placeholder="ä¾‹å¦‚ï¼šå°åŒ—è»Šç«™ã€å¿ å­æ±è·¯ä¸€æ®µ..." 
                        class="flex-1 p-3 border border-indigo-300 rounded-lg text-sm min-w-0 focus:border-indigo-600 focus:ring-indigo-600 shadow-sm"
                        value="å°åŒ—è»Šç«™"
                    >
                    <button 
                        id="search-location-btn" 
                        class="p-3 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700 transition shadow-md whitespace-nowrap flex items-center justify-center"
                    >
                        <!-- Search Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        æœå°‹åœ°é»
                    </button>
                </div>
            </div>

            <!-- ğŸ“ ç›®å‰è¨­å®šçš„ä½ç½®ç‹€æ…‹é¡¯ç¤º -->
            <div id="location-status" class="flex-1 p-3 bg-gray-200 rounded-lg text-sm text-gray-700 font-medium flex items-center mb-6 border border-gray-300">
                <!-- Loader Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                è«‹è¼¸å…¥åœ°å€ä¸¦é»æ“Šã€Œæœå°‹åœ°é»ã€...
            </div>
            
            <!-- ğŸ—ºï¸ Leaflet åœ°åœ–å®¹å™¨ -->
            <div id="map-container" class="mb-6 bg-gray-100 flex items-center justify-center text-gray-400">
                åœ°åœ–è¼‰å…¥ä¸­...
            </div>


            <!-- âš™ï¸ ç¯©é¸å™¨ -->
            <div class="flex flex-wrap gap-4 mt-6 mb-6 p-4 border rounded-xl bg-gray-50">
                
                <!-- åˆé¤/æ™šé¤åˆ‡æ› (æ™‚æ®µç¯©é¸ç‚ºæ¨¡æ“¬) -->
                <div class="flex-1 min-w-[120px]">
                    <label for="meal-selector" class="text-xs font-semibold text-gray-600 flex items-center mb-1">
                        <!-- Clock Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        æ™‚æ®µ
                    </label>
                    <select id="meal-selector" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="åˆé¤">åˆé¤ (Lunch)</option>
                        <option value="æ™šé¤">æ™šé¤ (Dinner)</option>
                    </select>
                </div>
                
                <!-- åƒ¹ä½ç¯©é¸ (Nominatim ç„¡çœŸå¯¦æ•¸æ“šï¼Œæ­¤ç‚ºéš¨æ©Ÿæ¨¡æ“¬) -->
                <div class="flex-1 min-w-[120px]">
                    <label for="price-filter" class="text-xs font-semibold text-gray-600 flex items-center mb-1">
                        <!-- DollarSign Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        æœ€é«˜åƒ¹ä½ (æ¨¡æ“¬)
                    </label>
                    <select id="price-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="5">ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’° (ä¸é™)</option>
                        <option value="4">ğŸ’°ğŸ’°ğŸ’°ğŸ’° (ä¸­é«˜)</option>
                        <option value="3">ğŸ’°ğŸ’°ğŸ’° (ä¸­ç­‰)</option>
                        <option value="2">ğŸ’°ğŸ’° (å¹³åƒ¹)</option>
                        <option value="1">ğŸ’° (è¶…å€¼)</option>
                    </select>
                </div>

                <!-- è·é›¢ç¯©é¸ (æ ¹æ“š OSM åº§æ¨™è¨ˆç®—è·é›¢) -->
                <div class="flex-1 min-w-[120px]">
                    <label for="distance-filter" class="text-xs font-semibold text-gray-600 flex items-center mb-1">
                        <!-- MapPin Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        æœ€å¤§è·é›¢ (km)
                    </label>
                    <select id="distance-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">1 km</option>
                        <option value="3" selected>3 km</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="99">ä¸é™è·é›¢</option>
                    </select>
                </div>
            </div>

            <!-- éš¨æ©Ÿé¸æ“‡æŒ‰éˆ• -->
            <button
                id="local-select-btn"
                class="w-full py-3 mb-4 bg-red-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-red-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center transform hover:scale-[1.01] active:scale-100"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 animate-bounce"><path d="M12.5 17.5 17 21l-5.5-5.5"/><path d="M15 6.5 20 2l-3 3"/><path d="M2 12s2-4 6-4 6 4 6 4"/><path d="M2 12s2 4 6 4 6-4 6-4"/></svg>
                è«‹å…ˆè¨­å®šåœ°é»
            </button>

            <!-- åº—å®¶åˆ—è¡¨ -->
            <div id="local-stores-list" class="mt-4 space-y-3 max-h-80 overflow-y-auto pr-2 custom-scrollbar">
                <h3 class="text-lg font-semibold text-gray-700">ç¬¦åˆæ¢ä»¶çš„åº—å®¶é è¦½:</h3>
                <div class="text-center text-gray-500 p-4">è«‹å…ˆè¼¸å…¥åœ°å€ä¸¦æœå°‹åœ°é»ã€‚</div>
            </div>
        </section>

    </main>

    <!-- éš¨æ©Ÿçµæœ Modal -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden" style="z-index: 1000;">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center transform scale-100 transition-transform duration-300">
            <div class="mb-4">
                <!-- Sparkles Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 text-yellow-500 mx-auto animate-pulse"><path d="m12 3-1.92 5.8 5.46 3.86-5.46-3.86-1.92 5.8 5.46-3.86-5.46 3.86-1.92-5.8 5.46 3.86-5.46-3.86z"/><path d="m22 17-1.92 5.8 5.46 3.86-5.46-3.86-1.92 5.8 5.46-3.86-5.46 3.86-1.92-5.8 5.46 3.86-5.46-3.86z"/><path d="m18 10-1.92 5.8 5.46 3.86-5.46-3.86-1.92 5.8 5.46-3.86-5.46 3.86-1.92-5.8 5.46 3.86-5.46-3.86z"/></svg>
            </div>
            <h2 id="modal-title" class="text-2xl font-extrabold text-gray-900 mb-2">æ±ºå®šæ˜¯å®ƒäº†ï¼</h2>
            <p id="modal-source" class="text-sm text-gray-500 mb-4">ä¾†è‡ª é™„è¿‘åº—å®¶ çš„æ¨è–¦</p>

            <div class="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                <p id="modal-restaurant-name" class="text-3xl font-black text-yellow-800"></p>
                <p id="modal-restaurant-cuisine" class="mt-1 text-lg text-yellow-700"></p>
            </div>

            <button
                id="modal-close-btn"
                class="mt-6 w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition"
            >
                å¤ªæ£’äº†ï¼Œæˆ‘è¦å»åƒï¼
            </button>
        </div>
    </div>

    <!-- è¼‰å…¥ Leaflet JS (OpenStreetMap) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // =======================================================
        // ğŸ“Œ å…¨åŸŸç‹€æ…‹ (Global State)
        // =======================================================
        
        const DEFAULT_LAT = 25.04776; 
        const DEFAULT_LNG = 121.51731;

        const state = {
            userLocation: {
                lat: null,
                lng: null,
                status: 'è«‹è¼¸å…¥åœ°å€ä¸¦é»æ“Šã€Œæœå°‹åœ°é»ã€...',
                address: ''
            },
            localStores: [],
            isLoading: false,
            selectedMeal: 'åˆé¤',
            filters: {
                price: 5,
                maxDistance: 3,
            },
        };
        
        let map = null;
        let markers = [];

        // =======================================================
        // ğŸ› ï¸ è¼”åŠ©å·¥å…·å‡½æ•¸ (Helper Functions)
        // =======================================================
        
        /**
         * åŸ·è¡Œ API è«‹æ±‚ï¼Œå¸¶æœ‰é‡è©¦æ©Ÿåˆ¶å’Œé€Ÿç‡é™åˆ¶ç­‰å¾…ã€‚
         */
        const fetchWithRateLimit = async (url) => {
            // Nominatim é€Ÿç‡é™åˆ¶ï¼šæ¯æ¬¡è«‹æ±‚å¾Œç­‰å¾… 1.5 ç§’
            await new Promise(resolve => setTimeout(resolve, 1500)); 

            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'WhatToEatApp/1.0 (Contact: user@example.com)'
                }
            });
            
            if (!response.ok) {
                if (response.status === 429) {
                    throw new Error(`API è«‹æ±‚éå¿« (429)ï¼Œè«‹ç¨å€™å†è©¦ã€‚`);
                }
                if (response.status === 400) {
                    throw new Error(`æœå°‹åƒæ•¸éŒ¯èª¤ (400)ï¼Œè«‹å˜—è©¦ç°¡åŒ–åœ°å€æˆ–æœå°‹é—œéµå­—ã€‚`);
                }
                throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
            }
            return response.json();
        };

        const setState = (newState) => {
            Object.assign(state, newState);
            updateUI();
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        };

        const createStoreCard = (store) => {
            return `
                <div class="p-4 bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-gray-100 flex justify-between items-center transform transition duration-300 hover:scale-[1.01]">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${store.name}</h3>
                        <p class="text-sm text-gray-500">${store.cuisine} (${store.type_key})</p>
                        <div class="flex items-center space-x-2 mt-1 text-xs">
                            <span class="flex items-center text-yellow-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                ${store.rating} <span class="text-gray-400">(æ¨¡æ“¬)</span>
                            </span>
                            <span class="text-blue-500 font-medium">${store.distance.toFixed(1)} km</span>
                            <span class="text-green-600">${'ğŸ’°'.repeat(store.price)} <span class="text-gray-400">(æ¨¡æ“¬)</span></span>
                        </div>
                    </div>
                </div>
            `;
        };

        // ---------------------------------------------------
        // Leaflet åœ°åœ–å‡½æ•¸ (Map Functions)
        // ---------------------------------------------------

        const initMap = (lat, lng) => {
            if (map) return; 

            // ğŸ›‘ é‡è©¦æ©Ÿåˆ¶ï¼šå¦‚æœ L æœªå®šç¾©ï¼Œç­‰å¾… 100ms å¾Œé‡è©¦
            if (typeof L === 'undefined' || typeof L.map === 'undefined') {
                 console.warn("Leaflet.js å°šæœªè¼‰å…¥ï¼Œ100ms å¾Œé‡è©¦...");
                 setTimeout(() => initMap(lat, lng), 100);
                 return;
            }

            try {
                map = L.map('map-container').setView([lat, lng], 14);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                }).addTo(map);
                
                console.log("Leaflet åœ°åœ–åˆå§‹åŒ–æˆåŠŸï¼");
            } catch (e) {
                console.error("åœ°åœ–åˆå§‹åŒ–å¤±æ•—:", e);
            }
        };

        const updateMap = (lat, lng, stores) => {
            if (!map) {
                initMap(lat, lng);
                if (!map) {
                    setTimeout(() => updateMap(lat, lng, stores), 500);
                    return;
                }
            }
            
            map.setView([lat, lng], 14);
            
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const searchMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-search-icon',
                    html: `<div class="bg-red-600 text-white text-xs font-bold p-1 rounded-full w-6 h-6 flex items-center justify-center shadow-lg transform hover:scale-110 transition">ğŸ </div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map)
                .bindPopup(`<b>åŸºæº–åœ°å€:</b> ${state.userLocation.address}`)
                .openPopup();
            markers.push(searchMarker);
            
            stores.slice(0, 10).forEach((store, index) => { 
                const marker = L.marker([store.lat, store.lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="bg-indigo-600 text-white text-xs font-bold p-1 rounded-full w-6 h-6 flex items-center justify-center shadow-lg transform hover:scale-110 transition">${index + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map)
                .bindPopup(`<b>${store.name}</b><br>${store.cuisine}<br>${store.distance.toFixed(2)} km`);
                markers.push(marker);
            });
        };


        // ---------------------------------------------------
        // DOM æ›´æ–°å‡½æ•¸ (Update UI)
        // ---------------------------------------------------

        const updateUI = () => {
            const { userLocation, localStores, isLoading, filters, selectedMeal } = state;

            const locationEl = document.getElementById('location-status');
            const localBtnEl = document.getElementById('local-select-btn');

            let icon = '';
            let bgColorClass = '';
            let iconColorClass = '';
            
            if (isLoading) {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
                bgColorClass = 'bg-yellow-100';
                iconColorClass = 'text-yellow-700';
                locationEl.innerHTML = `${icon} æ­£åœ¨ä½¿ç”¨ Nominatim æœå°‹åœ°å€å’Œé™„è¿‘åº—å®¶... (è«‹è€å¿ƒç­‰å¾…)`;
                locationEl.className = `flex-1 p-3 rounded-lg text-sm font-medium flex items-center mb-6 border border-yellow-300 ${bgColorClass} ${iconColorClass}`;
                localBtnEl.textContent = 'è¼‰å…¥ä¸­...';
                localBtnEl.disabled = true;

            } else if (userLocation.lat && userLocation.lng) {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`; 
                bgColorClass = 'bg-green-100';
                iconColorClass = 'text-green-700';
                
                let locationText = `âœ… åŸºæº–åœ°å€ï¼š${userLocation.address} <span class="text-xs text-green-500">(Lat: ${userLocation.lat.toFixed(4)}, Lng: ${userLocation.lng.toFixed(4)})</span>`;

                locationEl.className = `flex-1 p-3 rounded-lg text-sm font-medium flex items-center mb-6 border border-green-300 ${bgColorClass} ${iconColorClass}`;
                locationEl.innerHTML = `${icon} ${locationText}`;
            } else {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M2 12s2-4 6-4 6 4 6 4"/><path d="M2 12s2 4 6 4 6-4 6-4"/><path d="M12 2v20M5 12h14"/></svg>`; 
                bgColorClass = 'bg-gray-200';
                iconColorClass = 'text-gray-700';
                locationEl.className = `flex-1 p-3 rounded-lg text-sm text-gray-700 font-medium flex items-center mb-6 border border-gray-300`;
                locationEl.innerHTML = `${icon} ${userLocation.status}`;
            }

            const isLocationSet = userLocation.lat !== null;
            const filteredLocalStores = isLocationSet ? localStores.filter(store => {
                if (store.price > filters.price) return false;
                if (store.distance > filters.maxDistance) return false;
                if (selectedMeal === 'æ™šé¤' && (store.name.includes('æ—©é¤') || store.name.includes('æ—©åˆé¤'))) return false; 
                return true;
            }) : [];

            const localListEl = document.getElementById('local-stores-list');
            const localCountEl = document.getElementById('local-store-count');
            
            localCountEl.textContent = filteredLocalStores.length;
            localListEl.innerHTML = ''; 

            if (!isLocationSet && !isLoading) {
                 localBtnEl.textContent = 'è«‹å…ˆè¨­å®šåœ°é»';
                 localBtnEl.disabled = true;
                 localListEl.innerHTML = '<h3 class="text-lg font-semibold text-gray-700">ç¬¦åˆæ¢ä»¶çš„åº—å®¶é è¦½:</h3><div class="text-center text-gray-500 p-4">è«‹å…ˆè¼¸å…¥åœ°å€ä¸¦æœå°‹åœ°é»ã€‚</div>';
            } else if (isLoading) {
                localListEl.innerHTML = '<h3 class="text-lg font-semibold text-gray-700">ç¬¦åˆæ¢ä»¶çš„åº—å®¶é è¦½:</h3><div class="text-center text-gray-500 p-4">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç­‰å¾… Leaflet/OSM è«‹æ±‚å®Œæˆ...</div>';
            } else if (filteredLocalStores.length === 0) {
                localListEl.innerHTML = '<h3 class="text-lg font-semibold text-gray-700">ç¬¦åˆæ¢ä»¶çš„åº—å®¶é è¦½:</h3><p class="text-center text-gray-500 p-4">Nominatim æœå°‹ä¸åˆ°ç¬¦åˆæ¢ä»¶åº—å®¶ï¼Œè«‹å˜—è©¦æ›´æ›åœ°å€æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚</p>';
                localBtnEl.textContent = 'ç„¡ç¬¦åˆæ¢ä»¶åº—å®¶';
                localBtnEl.disabled = true;
            } else {
                localBtnEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 animate-bounce"><path d="M12.5 17.5 17 21l-5.5-5.5"/><path d="M15 6.5 20 2l-3 3"/><path d="M2 12s2-4 6-4 6 4 6 4"/><path d="M2 12s2 4 6 4 6-4 6-4"/></svg>
                    å¾ ${filteredLocalStores.length} é–“ä¸­éš¨æ©Ÿé¸æ“‡ï¼
                `;
                localBtnEl.disabled = false;
                
                const limitedStores = filteredLocalStores.slice(0, 5);
                const listHtml = limitedStores.map(store => createStoreCard(store)).join('');
                
                localListEl.innerHTML = `<h3 class="text-lg font-semibold text-gray-700">ç¬¦åˆæ¢ä»¶çš„åº—å®¶é è¦½:</h3><div class="space-y-3 mt-3">${listHtml}</div>`;
                if (filteredLocalStores.length > 5) {
                    localListEl.innerHTML += `<p class="text-sm text-center text-gray-500 mt-2">... é‚„æœ‰ ${filteredLocalStores.length - 5} é–“ç¬¦åˆæ¢ä»¶çš„åº—å®¶</p>`;
                }
            }
        };

        // ---------------------------------------------------
        // æ ¸å¿ƒé‚è¼¯å‡½æ•¸ (Core Logic)
        // ---------------------------------------------------

        const searchLocationAndFetchStores = async (address) => {
            if (!address.trim()) {
                setState({ 
                    userLocation: { lat: null, lng: null, status: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ°å€ã€‚', address: '' }, 
                    localStores: [],
                    isLoading: false 
                });
                return;
            }
            
            setState({ isLoading: true });

            try {
                // 1. Geocoding
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1&addressdetails=1`;
                console.log(`[Nominatim Geocoding] URL: ${geocodeUrl}`);
                const geocodeData = await fetchWithRateLimit(geocodeUrl);

                if (!geocodeData || geocodeData.length === 0) {
                     setState({ 
                        userLocation: { lat: null, lng: null, status: 'âŒ Geocoding å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²åœ°å€ã€‚', address: address }, 
                        localStores: [],
                        isLoading: false 
                    });
                    return;
                }

                const geoResult = geocodeData[0];
                const lat = parseFloat(geoResult.lat);
                const lng = parseFloat(geoResult.lon);
                
                // 2. Places Search (FIXED: Simplified query to avoid 400 Bad Request)
                // åŸæœ¬ä½¿ç”¨ "restaurant near ..." å®¹æ˜“å°è‡´ 400 éŒ¯èª¤ã€‚
                // æ”¹ç‚ºåœ¨ viewbox å…§æœå°‹ "restaurant" é—œéµå­—ï¼Œä¸¦çµåˆ bounded=1
                // æ“´å¤§ä¸€é»ç¯„åœ (0.015 ç´„ 1.5km)
                const boundSize = 0.015;
                const viewboxStr = `${lng - boundSize},${lat - boundSize},${lng + boundSize},${lat + boundSize}`;
                
                // ä½¿ç”¨ amenity=restaurant çµæ§‹åŒ–æŸ¥è©¢å¯èƒ½æ›´ç©©ï¼Œä½† search æ¥å£ä¸»è¦ç”¨ q
                // é€™è£¡æ”¹ç”¨ q=restaurant é…åˆ bounded=1
                const placesUrl = `https://nominatim.openstreetmap.org/search?q=restaurant&format=json&limit=50&viewbox=${viewboxStr}&bounded=1`;
                
                console.log(`[Nominatim Places Search] URL: ${placesUrl}`);
                const placesData = await fetchWithRateLimit(placesUrl);
                
                // 3. Process Data
                const originLat = lat;
                const originLng = lng;

                const stores = placesData.map(p => {
                    const storeLat = parseFloat(p.lat);
                    const storeLng = parseFloat(p.lon);
                    
                    return {
                        id: p.osm_id,
                        name: p.name || p.display_name.split(',')[0] || 'æœªçŸ¥é¤å»³', 
                        cuisine: p.type || 'ç¾é£Ÿ',
                        type_key: p.class, 
                        lat: storeLat,
                        lng: storeLng,
                        distance: calculateDistance(originLat, originLng, storeLat, storeLng),
                        price: Math.floor(Math.random() * 5) + 1, 
                        rating: (Math.random() * (5 - 3.5) + 3.5).toFixed(1)
                    };
                }).filter(store => store.distance > 0.005) // ç¨å¾®éæ¿¾æ‰è·é›¢æ¥µè¿‘çš„é»
                  .sort((a, b) => a.distance - b.distance); 

                setState({ 
                    userLocation: { lat, lng, status: 'å·²æˆåŠŸè¼‰å…¥åº—å®¶æ•¸æ“šã€‚', address: address },
                    localStores: stores,
                    isLoading: false 
                });
                
                updateMap(lat, lng, stores);

            } catch (error) {
                console.error("API è«‹æ±‚éŒ¯èª¤:", error);
                setState({ 
                    userLocation: { lat: null, lng: null, status: `âŒ ${error.message}`, address: '' }, 
                    localStores: [],
                    isLoading: false 
                });
            }
        };

        const handleAddressSearch = () => {
            const addressInput = document.getElementById('search-address').value;
            // åœ°åœ–åˆå§‹åŒ–ç”± updateMap è™•ç†
            searchLocationAndFetchStores(addressInput);
        };

        const handleRandomSelect = () => {
            const { localStores, filters, selectedMeal } = state;
            
            const listToChoose = localStores.filter(store => {
                if (store.price > filters.price) return false;
                if (store.distance > filters.maxDistance) return false;
                if (selectedMeal === 'æ™šé¤' && (store.name.includes('æ—©é¤') || store.name.includes('æ—©åˆé¤'))) return false;
                return true;
            });

            let result = null;
            if (listToChoose.length === 0) {
                result = { name: 'ğŸ˜¢ æŠ±æ­‰', cuisine: 'ç„¡ç¬¦åˆæ¢ä»¶çš„åº—å®¶' };
            } else {
                const randomIndex = Math.floor(Math.random() * listToChoose.length);
                result = listToChoose[randomIndex];
            }

            showResultModal(result, 'é™„è¿‘åº—å®¶');
        };
        
        const showResultModal = (result, source) => {
            document.getElementById('modal-restaurant-name').textContent = result.name;
            document.getElementById('modal-restaurant-cuisine').textContent = result.name === 'ğŸ˜¢ æŠ±æ­‰' ? '' : `${result.cuisine} (è·é›¢: ${result.distance ? result.distance.toFixed(2) + ' km' : 'N/A'})`;
            document.getElementById('modal-title').textContent = result.name === 'ğŸ˜¢ æŠ±æ­‰' ? result.name : 'æ±ºå®šæ˜¯å®ƒäº†ï¼';
            document.getElementById('modal-source').textContent = result.name === 'ğŸ˜¢ æŠ±æ­‰' ? result.cuisine : `ä¾†è‡ª ${source} çš„æ¨è–¦`;

            document.getElementById('result-modal').classList.remove('hidden');
        };

        const hideResultModal = () => {
            document.getElementById('result-modal').classList.add('hidden');
        };


        // ---------------------------------------------------
        // ğŸš€ åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½
        // ---------------------------------------------------

        window.onload = () => {
            // 1. åˆå§‹ UI ç‹€æ…‹
            updateUI();
            
            // 2. ç¯©é¸å™¨äº‹ä»¶ç›£è½
            document.getElementById('meal-selector').addEventListener('change', (e) => {
                setState({ selectedMeal: e.target.value });
            });
            document.getElementById('price-filter').addEventListener('change', (e) => {
                setState({ filters: { ...state.filters, price: parseInt(e.target.value) } });
            });
            document.getElementById('distance-filter').addEventListener('change', (e) => {
                setState({ filters: { ...state.filters, maxDistance: parseInt(e.target.value) } });
            });

            // 3. åœ°å€æœå°‹äº‹ä»¶ç›£è½
            const searchBtn = document.getElementById('search-location-btn');
            const searchInput = document.getElementById('search-address');

            searchBtn.addEventListener('click', handleAddressSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAddressSearch();
                }
            });

            // 4. éš¨æ©Ÿé¸æ“‡æŒ‰éˆ•äº‹ä»¶ç›£è½
            document.getElementById('local-select-btn').addEventListener('click', handleRandomSelect);

            // 5. Modal é—œé–‰äº‹ä»¶ç›£è½
            document.getElementById('modal-close-btn').addEventListener('click', hideResultModal);
            document.getElementById('result-modal').addEventListener('click', (e) => {
                if (e.target.id === 'result-modal') {
                    hideResultModal();
                }
            });
            
            // 6. é¦–æ¬¡è¼‰å…¥åœ°åœ– (åˆå§‹åŒ–åˆ°é è¨­ä½ç½®)
            initMap(DEFAULT_LAT, DEFAULT_LNG);
        };
    </script>
</body>
</html>
